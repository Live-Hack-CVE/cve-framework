const config = JSON.parse(Deno.readTextFileSync("./config.json"))

import { contact } from "./contact/main.ts"
import { messagebuilder } from "./utils/message.ts"

let cachedCVE:any = []

async function main() {
    // step 1: get the new data
    const data = await fetch("https://cve.live-hack.org/api/last")

    // step 2: only keep the new data that are not already in the cache
    const newData = (await data.json()).filter((cve:any) => !cachedCVE.find((c:any) => c.id == cve.id))

    // step 3: analyze the new data
    for (const cve of newData) {
        for(const word of config.words) {
            // here check if the word is in the cve: summary, references, vulnerable_product, vulnerable_configuration, id
            if(cve.summary.includes(word) || cve.references.includes(word) || cve.vulnerable_product.includes(word) || cve.vulnerable_configuration.includes(word) || cve.id.includes(word)) {
                // here send the cve to the webhook
                console.log(`Found ${word} in ${cve.id}`)
                await contact(messagebuilder(cve))
            }
        }
        // step 4: update the cache at the same time
        cachedCVE.push(cve)
    }

    // only keep the last 1000 cve
    cachedCVE = cachedCVE.slice(-1000)
}


main()
setInterval(main, config.interval)